---
phase: 07-campaign-system
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - apps/dashboard/src/lib/api.ts
  - apps/dashboard/src/app/rewards/page.tsx
  - apps/dashboard/src/app/rewards/admin/page.tsx
  - apps/dashboard/src/components/campaigns/campaign-card.tsx
  - apps/dashboard/src/components/campaigns/campaign-form.tsx
  - apps/dashboard/src/components/campaigns/campaign-rules.tsx
  - apps/dashboard/src/components/campaigns/campaign-history.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can create campaigns via UI modal"
    - "Admin can edit campaigns and see audit history"
    - "Admin can publish and end campaigns"
    - "Users see campaign rules with worked example"
    - "Users see past campaign history with their stats"
  artifacts:
    - path: "apps/dashboard/src/app/rewards/admin/page.tsx"
      provides: "Admin campaign management interface"
      min_lines: 100
    - path: "apps/dashboard/src/components/campaigns/campaign-rules.tsx"
      provides: "Campaign rules explanation with worked example"
      exports: ["CampaignRules"]
    - path: "apps/dashboard/src/components/campaigns/campaign-history.tsx"
      provides: "Past campaign history with user stats"
      exports: ["CampaignHistory"]
  key_links:
    - from: "apps/dashboard/src/app/rewards/admin/page.tsx"
      to: "/api/rewards/campaigns"
      via: "fetch via api client"
      pattern: "api\\..*[Cc]ampaign"
    - from: "apps/dashboard/src/components/campaigns/campaign-rules.tsx"
      to: "/api/rewards/campaigns/active"
      via: "useQuery fetch"
      pattern: "useQuery.*campaigns"
---

<objective>
Admin campaign management UI and user-facing campaign displays

Purpose: Enable admins to manage campaigns through the dashboard and show users campaign rules with worked examples and history
Output: Admin campaign page, campaign rules component, history view with participation stats
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-campaign-system/07-CONTEXT.md
@.planning/phases/07-campaign-system/07-RESEARCH.md
@.planning/phases/07-campaign-system/07-01-SUMMARY.md
@apps/dashboard/src/lib/api.ts
@apps/dashboard/src/components/create-facilitator-modal.tsx
@apps/dashboard/src/components/rewards/enrollment-modal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add campaign API client methods and types</name>
  <files>
    apps/dashboard/src/lib/api.ts
  </files>
  <action>
    Add Campaign types near other rewards types:

    ```typescript
    export interface Campaign {
      id: string;
      name: string;
      pool_amount: string;
      threshold_amount: string;
      multiplier_facilitator: number;
      starts_at: string;
      ends_at: string;
      status: 'draft' | 'published' | 'active' | 'ended';
      distributed_amount?: string;
      created_at: string;
      updated_at: string;
    }

    export interface CampaignAudit {
      id: string;
      campaign_id: string;
      admin_user_id: string;
      action: 'create' | 'update' | 'publish' | 'end';
      changes: string;
      created_at: string;
    }

    export interface CampaignWithAudit extends Campaign {
      audit: CampaignAudit[];
    }

    export interface CampaignStats {
      totalVolume: string;
      participantCount: number;
      userRank?: number;
      userVolume?: string;
    }

    export interface CampaignHistoryItem {
      campaign: Campaign;
      userVolume: string;
      userRank: number | null;
      metThreshold: boolean;
      multiplierApplied: number;
      estimatedReward: string | null;
      claimed: boolean;
    }

    export interface CreateCampaignRequest {
      name: string;
      pool_amount: string;
      threshold_amount: string;
      multiplier_facilitator?: number;
      starts_at: string;
      ends_at: string;
    }
    ```

    Add API client methods to ApiClient class:

    ```typescript
    // Admin Campaign Management
    async getCampaigns(status?: string): Promise<Campaign[]> {
      const url = status ? `/api/rewards/campaigns?status=${status}` : '/api/rewards/campaigns';
      return this.request(url);
    }

    async getCampaign(id: string): Promise<CampaignWithAudit> {
      return this.request(`/api/rewards/campaigns/${id}`);
    }

    async createCampaign(data: CreateCampaignRequest): Promise<Campaign> {
      return this.request('/api/rewards/campaigns', {
        method: 'POST',
        body: JSON.stringify(data),
      });
    }

    async updateCampaign(id: string, data: Partial<CreateCampaignRequest>): Promise<Campaign> {
      return this.request(`/api/rewards/campaigns/${id}`, {
        method: 'PATCH',
        body: JSON.stringify(data),
      });
    }

    async publishCampaign(id: string): Promise<Campaign> {
      return this.request(`/api/rewards/campaigns/${id}/publish`, {
        method: 'POST',
      });
    }

    async endCampaign(id: string): Promise<Campaign> {
      return this.request(`/api/rewards/campaigns/${id}/end`, {
        method: 'POST',
      });
    }

    async deleteCampaign(id: string): Promise<void> {
      return this.request(`/api/rewards/campaigns/${id}`, {
        method: 'DELETE',
      });
    }

    // Public Campaign Endpoints
    async getActiveCampaign(): Promise<{ campaign: Campaign | null; totalVolume: string }> {
      return this.request('/api/rewards/campaigns/active');
    }

    async getCampaignHistory(): Promise<CampaignHistoryItem[]> {
      return this.request('/api/rewards/campaigns/history');
    }

    async getCampaignStats(id: string): Promise<CampaignStats> {
      return this.request(`/api/rewards/campaigns/${id}/stats`);
    }
    ```
  </action>
  <verify>npm run build in apps/dashboard - types and methods compile</verify>
  <done>Campaign types and API methods available in api.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create campaign components</name>
  <files>
    apps/dashboard/src/components/campaigns/campaign-card.tsx
    apps/dashboard/src/components/campaigns/campaign-form.tsx
    apps/dashboard/src/components/campaigns/campaign-rules.tsx
    apps/dashboard/src/components/campaigns/campaign-history.tsx
  </files>
  <action>
    Create apps/dashboard/src/components/campaigns/ directory

    1. campaign-card.tsx - Display single campaign summary
       - Props: campaign: Campaign, onEdit?: () => void, onPublish?: () => void, onEnd?: () => void
       - Show: name, pool amount, threshold, dates, status badge
       - Status badges: draft (gray), published (blue), active (green), ended (gray)
       - Format amounts with Intl.NumberFormat (assume atomic USDC -> divide by 1e6)
       - Format dates with date-fns
       - Show edit/publish/end buttons based on status and isAdmin prop

    2. campaign-form.tsx - Create/Edit campaign modal
       - Props: open, onOpenChange, campaign?: Campaign, onSuccess
       - useState for form fields: name, poolAmount, thresholdAmount, multiplier, startsAt, endsAt
       - Date inputs use type="datetime-local"
       - Validation: all required, dates must be ISO format, startsAt < endsAt
       - Use Dialog from @/components/ui/dialog
       - useMutation for create/update
       - Follow create-facilitator-modal.tsx patterns

    3. campaign-rules.tsx - Campaign rules explanation for users
       - Props: campaign: Campaign, userVolume: string, totalPoolVolume: string, isFacilitatorOwner: boolean
       - Display campaign name, pool amount, threshold
       - Show dates with countdown (days remaining if active)
       - WORKED EXAMPLE section (per CONTEXT.md):
         ```
         Your volume: $X
         Total pool volume: $Y
         Your share: X / Y = Z%
         Pool amount: $POOL $OPEN
         Your estimated reward: Z% * POOL = $REWARD $OPEN
         (If facilitator owner: "2x multiplier applied!")
         ```
       - Highlight 2x facilitator multiplier prominently
       - Show threshold status: "You've reached the threshold!" or "Process $X more to qualify"

    4. campaign-history.tsx - Past campaigns list with stats
       - Props: history: CampaignHistoryItem[]
       - Lifetime stats summary at top:
         - Total rewards earned (sum of claimed rewards)
         - Total volume processed
         - Campaigns participated in
       - List of past campaigns, most recent first:
         - Campaign name, dates
         - User's volume, rank
         - "Qualified" or "Did not qualify" badge
         - Multiplier if applied
         - Reward amount if claimed, or "Pending" if eligible but unclaimed
         - Show campaigns user didn't participate in as dimmed with "Did not participate"
  </action>
  <verify>npm run build - components compile without errors</verify>
  <done>Campaign components created: card, form modal, rules display, history list</done>
</task>

<task type="auto">
  <name>Task 3: Create admin and user campaign pages</name>
  <files>
    apps/dashboard/src/app/rewards/page.tsx
    apps/dashboard/src/app/rewards/admin/page.tsx
  </files>
  <action>
    1. Create or update apps/dashboard/src/app/rewards/page.tsx (user-facing):
       - 'use client'
       - Import CampaignRules, CampaignHistory from components/campaigns
       - useQuery for active campaign: api.getActiveCampaign()
       - useQuery for user volume: api.getRewardsVolume() (from Phase 6)
       - useQuery for campaign history: api.getCampaignHistory()
       - useAuth for isFacilitatorOwner
       - Layout:
         - If active campaign exists:
           - <CampaignRules campaign={...} userVolume={...} totalPoolVolume={...} isFacilitatorOwner={...} />
         - Else:
           - "No active campaign" message
         - Section divider
         - <CampaignHistory history={...} />
       - Loading states with skeleton UI
       - Link to admin page if isAdmin

    2. Create apps/dashboard/src/app/rewards/admin/page.tsx:
       - 'use client'
       - Protect: redirect if not isAdmin
       - useQuery for all campaigns: api.getCampaigns()
       - useState for form modal open, selected campaign
       - Layout:
         - Header: "Campaign Management" with "Create Campaign" button
         - Active/Published campaign section (if exists):
           - CampaignCard with End button
         - Draft campaigns section:
           - List of CampaignCards with Edit, Publish, Delete buttons
         - Ended campaigns section:
           - Collapsible list of ended campaigns
       - CampaignForm modal for create/edit
       - Confirmation dialogs for publish/end/delete actions
       - useMutation for publish, end, delete
       - Invalidate queries on success
  </action>
  <verify>
    npm run build - pages compile
    Navigate to /rewards - shows campaign rules or "no active campaign"
    Navigate to /rewards/admin (as admin) - shows campaign management
  </verify>
  <done>User rewards page with rules and history, admin campaign management page</done>
</task>

</tasks>

<verification>
1. npm run build in apps/dashboard completes without errors
2. /rewards page displays:
   - Active campaign rules with worked example (or "no active campaign")
   - Past campaign history with user participation stats
3. /rewards/admin page displays (admin only):
   - Create campaign button opens form modal
   - Campaign cards with status-appropriate actions
   - Confirmation for destructive actions
4. Campaign creation flow works end-to-end
</verification>

<success_criteria>
- Admin can create campaigns via dashboard modal
- Admin can edit, publish, and end campaigns
- Users see campaign rules with worked example calculation
- Users see 2x multiplier callout for facilitator owners
- Users see past campaign history with their participation stats
- History shows all campaigns including ones user didn't participate in
</success_criteria>

<output>
After completion, create `.planning/phases/07-campaign-system/07-02-SUMMARY.md`
</output>
