---
phase: 07-campaign-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/server/src/db/index.ts
  - packages/server/src/db/types.ts
  - packages/server/src/db/campaigns.ts
  - packages/server/src/db/campaign-audit.ts
  - packages/server/src/routes/rewards.ts
autonomous: true

must_haves:
  truths:
    - "Admin can create a new campaign via API"
    - "Admin can edit any campaign with audit logging"
    - "Admin can publish/end campaigns"
    - "Users can get active/published campaign details"
    - "System enforces single active campaign at a time"
  artifacts:
    - path: "packages/server/src/db/campaign-audit.ts"
      provides: "Audit logging CRUD for campaign changes"
      exports: ["createCampaignAudit", "getCampaignAuditHistory"]
    - path: "packages/server/src/routes/rewards.ts"
      provides: "Campaign API endpoints"
      contains: "router.post('/campaigns'"
  key_links:
    - from: "packages/server/src/routes/rewards.ts"
      to: "packages/server/src/db/campaigns.ts"
      via: "campaign CRUD calls"
      pattern: "createCampaign|updateCampaign"
    - from: "packages/server/src/routes/rewards.ts"
      to: "packages/server/src/db/campaign-audit.ts"
      via: "audit logging on updates"
      pattern: "createCampaignAudit"
---

<objective>
Campaign data model updates and admin/public API endpoints

Purpose: Enable campaign management via API with audit logging, status transitions, and single-active enforcement
Output: Schema with audit table, campaign API routes for admin CRUD and public queries
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-campaign-system/07-CONTEXT.md
@.planning/phases/07-campaign-system/07-RESEARCH.md
@packages/server/src/db/campaigns.ts
@packages/server/src/db/types.ts
@packages/server/src/routes/rewards.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add campaign_audit table and update schema</name>
  <files>
    packages/server/src/db/index.ts
    packages/server/src/db/types.ts
    packages/server/src/db/campaign-audit.ts
  </files>
  <action>
    1. In db/index.ts, add 'published' to campaigns status CHECK constraint:
       - Find: CHECK (status IN ('draft', 'active', 'ended'))
       - Replace with: CHECK (status IN ('draft', 'published', 'active', 'ended'))

    2. In db/index.ts, add campaign_audit table after campaigns table:
       ```sql
       CREATE TABLE IF NOT EXISTS campaign_audit (
         id TEXT PRIMARY KEY,
         campaign_id TEXT NOT NULL REFERENCES campaigns(id) ON DELETE CASCADE,
         admin_user_id TEXT NOT NULL,
         action TEXT NOT NULL CHECK (action IN ('create', 'update', 'publish', 'end')),
         changes TEXT NOT NULL DEFAULT '{}',
         created_at TEXT NOT NULL DEFAULT (datetime('now'))
       );
       CREATE INDEX IF NOT EXISTS idx_campaign_audit_campaign ON campaign_audit(campaign_id);
       ```

    3. In db/index.ts, add migration for existing databases:
       - Add to runMigrations() function:
         - ALTER TABLE campaigns ADD COLUMN distributed_amount TEXT DEFAULT '0' (if not exists)
         - Check if campaign_audit exists, create if not

    4. In db/types.ts, update CampaignRecord:
       - Add status option: 'published'
       - Add optional field: distributed_amount?: string

    5. In db/types.ts, add CampaignAuditRecord interface:
       ```typescript
       export interface CampaignAuditRecord {
         id: string;
         campaign_id: string;
         admin_user_id: string;
         action: 'create' | 'update' | 'publish' | 'end';
         changes: string; // JSON string
         created_at: string;
       }
       ```

    6. Create db/campaign-audit.ts with CRUD:
       - createCampaignAudit(data: { campaign_id, admin_user_id, action, changes })
       - getCampaignAuditHistory(campaignId: string): CampaignAuditRecord[]
       - Use nanoid for ID, follow existing CRUD patterns

    7. Export campaign-audit.ts from db/index.ts
  </action>
  <verify>npm run build in packages/server - no TypeScript errors</verify>
  <done>Campaign audit table exists, CampaignAuditRecord type defined, CRUD functions exported</done>
</task>

<task type="auto">
  <name>Task 2: Update campaigns.ts for published status and distributed_amount</name>
  <files>
    packages/server/src/db/campaigns.ts
  </files>
  <action>
    1. Update updateCampaign function to support 'published' status:
       - Change status type: 'draft' | 'published' | 'active' | 'ended'
       - Add distributed_amount to updates Partial type

    2. Add getPublishedCampaign function:
       - Returns campaign where status = 'published' OR status = 'active'
       - Used for user-facing "current campaign" queries
       - ORDER BY starts_at DESC LIMIT 1

    3. Add getCampaignsByStatus function:
       - getCampaignsByStatus(status: CampaignStatus): CampaignRecord[]
       - For admin filtering

    4. Add getCompletedCampaigns function:
       - Returns all campaigns where status = 'ended'
       - ORDER BY ends_at DESC
       - Used for history view

    5. Update createCampaign to support distributed_amount (defaults to '0')
  </action>
  <verify>npm run build - campaigns.ts compiles with new functions</verify>
  <done>Campaigns CRUD updated with published status, distributed_amount, and query helpers</done>
</task>

<task type="auto">
  <name>Task 3: Add campaign API routes</name>
  <files>
    packages/server/src/routes/rewards.ts
  </files>
  <action>
    Import at top:
    - import { createCampaignAudit, getCampaignAuditHistory } from '../db/campaign-audit.js'
    - import { getCampaignsByStatus, getPublishedCampaign, getCompletedCampaigns } from '../db/campaigns.js'
    - Add zod schemas for campaign validation

    Add Admin Routes (all require isAdmin check after requireAuth):

    1. POST /campaigns - Create draft campaign
       - Validate: name, pool_amount, threshold_amount, starts_at, ends_at, multiplier_facilitator (optional)
       - Create campaign with status='draft'
       - Create audit record (action='create')
       - Return created campaign

    2. GET /campaigns - List all campaigns (admin sees all statuses)
       - Optional query param: status (filter)
       - Return array of campaigns ordered by created_at DESC

    3. GET /campaigns/:id - Get campaign details
       - Admin sees full details including audit history
       - Return campaign + audit records

    4. PATCH /campaigns/:id - Update campaign (with audit)
       - Build changes object comparing old vs new
       - Create audit record (action='update') with changes
       - Return updated campaign

    5. POST /campaigns/:id/publish - Transition draft -> published
       - Verify current status is 'draft'
       - Update status to 'published'
       - Create audit record (action='publish')
       - Return updated campaign

    6. POST /campaigns/:id/end - End campaign early
       - Verify status is 'active' or 'published'
       - Update status to 'ended'
       - Create audit record (action='end')
       - Return updated campaign

    7. DELETE /campaigns/:id - Delete draft campaign only
       - Verify status is 'draft' (cannot delete published/active/ended)
       - Delete campaign
       - Return 204

    Add Public Routes (authenticated users):

    8. GET /campaigns/active - Get current campaign for users
       - Return published or active campaign (getPublishedCampaign)
       - Include calculated total pool volume (aggregate from volume_snapshots)
       - Return null if no current campaign

    9. GET /campaigns/history - User's campaign history
       - Get all ended campaigns (getCompletedCampaigns)
       - For each campaign, get user's participation data (volume, claims)
       - Return array with user stats per campaign

    10. GET /campaigns/:id/stats - Campaign statistics
        - Total qualifying volume (sum of all user volumes)
        - Participant count (distinct users with volume > 0)
        - User's rank if authenticated

    Validation schemas (using zod):
    ```typescript
    const createCampaignSchema = z.object({
      name: z.string().min(1).max(100),
      pool_amount: z.string().regex(/^\d+$/, 'Must be numeric string'),
      threshold_amount: z.string().regex(/^\d+$/, 'Must be numeric string'),
      multiplier_facilitator: z.number().min(1).max(10).optional(),
      starts_at: z.string().datetime(),
      ends_at: z.string().datetime(),
    });
    ```
  </action>
  <verify>
    npm run build - routes compile
    curl -X POST http://localhost:5002/api/rewards/campaigns -H "Content-Type: application/json" -d '{}' returns 401 (not authenticated)
  </verify>
  <done>Campaign API routes operational - admin CRUD, public queries for active campaign and history</done>
</task>

</tasks>

<verification>
1. npm run build in packages/server completes without errors
2. Campaign audit table created on database init
3. POST /api/rewards/campaigns returns 401 for unauthenticated
4. All new campaign functions exported from db/index.ts
</verification>

<success_criteria>
- Schema updated with campaign_audit table and distributed_amount column
- Campaign status supports: draft, published, active, ended
- Admin can CRUD campaigns via API with audit logging
- Public endpoints return current campaign and history
- Single active campaign enforced by business logic
</success_criteria>

<output>
After completion, create `.planning/phases/07-campaign-system/07-01-SUMMARY.md`
</output>
