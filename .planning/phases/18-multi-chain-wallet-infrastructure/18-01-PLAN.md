---
phase: 18-multi-chain-wallet-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/server/src/db/user-wallets.ts
  - packages/server/src/db/index.ts
  - packages/server/src/services/wallet.ts
  - packages/server/src/routes/admin.ts
  - apps/dashboard/src/lib/api.ts
autonomous: true

must_haves:
  truths:
    - "User can have both a Solana wallet and a Base wallet stored"
    - "API returns balance for each wallet by chain"
    - "User can create wallets for both chains independently"
  artifacts:
    - path: "packages/server/src/db/user-wallets.ts"
      provides: "Multi-wallet DB operations with unique constraint on (user_id, network)"
      contains: "getUserWalletsByUserId"
    - path: "packages/server/src/services/wallet.ts"
      provides: "Base wallet generation alongside Solana"
      contains: "generateBaseWalletForUser"
    - path: "packages/server/src/routes/admin.ts"
      provides: "Multi-wallet API endpoints"
      contains: "/wallets"
  key_links:
    - from: "packages/server/src/routes/admin.ts"
      to: "packages/server/src/services/wallet.ts"
      via: "generateBaseWalletForUser call"
      pattern: "generateBaseWalletForUser"
    - from: "packages/server/src/services/wallet.ts"
      to: "packages/server/src/db/user-wallets.ts"
      via: "createUserWallet with network param"
      pattern: "createUserWallet.*network"
---

<objective>
Extend backend to support multiple subscription wallets per user (Base + Solana)

Purpose: Enable dual-chain wallet storage and balance fetching for subscription payments
Output: API endpoints that return wallet info for both chains, with ability to create/query each independently
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-multi-chain-wallet-infrastructure/18-CONTEXT.md
@.planning/phases/18-multi-chain-wallet-infrastructure/18-RESEARCH.md
@packages/server/src/db/user-wallets.ts
@packages/server/src/services/wallet.ts
@packages/server/src/routes/admin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend user_wallets to support multiple wallets per user</name>
  <files>
    packages/server/src/db/user-wallets.ts
    packages/server/src/db/index.ts
  </files>
  <action>
Modify the user_wallets module to support multiple wallets per user (one per chain):

1. In `user-wallets.ts`:
   - Add `getUserWalletsByUserId(userId)` - returns array of all wallets for user
   - Add `getUserWalletByUserIdAndNetwork(userId, network)` - returns specific wallet
   - Update `createUserWallet` to check for existing wallet on same network before creating
   - Keep existing `getUserWalletByUserId` for backward compatibility (returns first/default wallet)

2. In `db/index.ts`:
   - Add migration to change UNIQUE constraint from `user_id` to `(user_id, network)`:
   ```sql
   -- Check if we need to migrate
   -- Create new table with correct constraint
   CREATE TABLE IF NOT EXISTS user_wallets_new (
     id TEXT PRIMARY KEY,
     user_id TEXT NOT NULL REFERENCES "user" ("id") ON DELETE CASCADE,
     wallet_address TEXT NOT NULL,
     encrypted_private_key TEXT NOT NULL,
     network TEXT NOT NULL DEFAULT 'solana',
     created_at TEXT NOT NULL DEFAULT (datetime('now')),
     UNIQUE(user_id, network)
   );
   -- Copy data
   INSERT INTO user_wallets_new SELECT * FROM user_wallets;
   -- Swap tables
   DROP TABLE user_wallets;
   ALTER TABLE user_wallets_new RENAME TO user_wallets;
   -- Recreate indexes
   CREATE INDEX IF NOT EXISTS idx_user_wallets_user ON user_wallets(user_id);
   CREATE INDEX IF NOT EXISTS idx_user_wallets_address ON user_wallets(wallet_address);
   ```

Important: The migration should only run if the constraint needs updating (check UNIQUE constraint first).
  </action>
  <verify>
Run the server and check logs for successful migration. Query the database to verify the new constraint exists.
  </verify>
  <done>
getUserWalletsByUserId returns array. getUserWalletByUserIdAndNetwork works. UNIQUE(user_id, network) constraint in place.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Base wallet generation service</name>
  <files>
    packages/server/src/services/wallet.ts
  </files>
  <action>
Extend the wallet service to generate Base chain wallets:

1. Import viem's `generatePrivateKey` and `privateKeyToAccount` from viem/accounts
2. Add `generateBaseWalletForUser(userId)`:
   - Check if Base wallet already exists for user via `getUserWalletByUserIdAndNetwork(userId, 'base')`
   - If exists, return `{ address, created: false }`
   - Generate new wallet using viem:
     ```typescript
     import { generatePrivateKey, privateKeyToAccount } from 'viem/accounts';
     const privateKey = generatePrivateKey();
     const account = privateKeyToAccount(privateKey);
     ```
   - Encrypt private key (same encryptPrivateKey function)
   - Store via createUserWallet with network='base'
   - Return `{ address: account.address, created: true }`

3. Add `getBaseUSDCBalance(address)`:
   - Use viem's publicClient with Base chain
   - Query USDC balance (contract: 0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913)
   - Use readContract with balanceOf ABI
   - Return `{ balance: bigint, formatted: string }` (6 decimals)

4. Add `getAllWalletsForUser(userId)`:
   - Get all wallets via getUserWalletsByUserId
   - Return array of `{ address, network }` objects

Important: Use the existing encryptPrivateKey/decryptPrivateKey from utils/crypto.ts.
Base USDC has 6 decimals, same as Solana USDC.
  </action>
  <verify>
Write a quick test in the route file that calls generateBaseWalletForUser and getBaseUSDCBalance with a known address.
  </verify>
  <done>
generateBaseWalletForUser creates Base wallets. getBaseUSDCBalance fetches USDC balance from Base chain. getAllWalletsForUser returns all user wallets.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add multi-wallet API endpoints</name>
  <files>
    packages/server/src/routes/admin.ts
    apps/dashboard/src/lib/api.ts
  </files>
  <action>
Add new API endpoints for multi-wallet support:

1. In `admin.ts`, add new endpoints (keep existing `/wallet` endpoint for backward compatibility):

```typescript
/**
 * GET /api/admin/wallets - Get all user wallets with balances
 */
router.get('/wallets', requireAuth, async (req, res) => {
  // Get all wallets for user
  // For each wallet, fetch balance (Solana USDC or Base USDC based on network)
  // Return array: [{ network, address, balance, token }]
});

/**
 * GET /api/admin/wallets/:chain - Get specific wallet by chain
 * chain = 'solana' | 'base'
 */
router.get('/wallets/:chain', requireAuth, async (req, res) => {
  // Validate chain is 'solana' or 'base'
  // Get wallet by user + network
  // Fetch balance
  // Return { network, address, balance, token } or 404 if no wallet
});

/**
 * POST /api/admin/wallets/:chain/create - Create wallet for specific chain
 * chain = 'solana' | 'base'
 */
router.post('/wallets/:chain/create', requireAuth, async (req, res) => {
  // Validate chain
  // Call appropriate generate function
  // Return { address, network, created, message }
});

/**
 * GET /api/admin/wallets/:chain/balance - Refresh balance for specific wallet
 */
router.get('/wallets/:chain/balance', requireAuth, async (req, res) => {
  // Get wallet
  // Fetch fresh balance
  // Return { balance, token }
});
```

2. In `api.ts`, add types and methods:

```typescript
export interface SubscriptionWallet {
  network: 'solana' | 'base';
  address: string;
  balance: string;
  token: string;
}

// In ApiClient class:
async getSubscriptionWallets(): Promise<SubscriptionWallet[]>
async getSubscriptionWallet(chain: 'solana' | 'base'): Promise<SubscriptionWallet | null>
async createSubscriptionWallet(chain: 'solana' | 'base'): Promise<{ address: string; network: string; created: boolean; message: string }>
async refreshWalletBalance(chain: 'solana' | 'base'): Promise<{ balance: string; token: string }>
```

Important:
- Keep existing `/wallet` endpoint working for backward compatibility
- New endpoints use `/wallets` (plural) with chain parameter
- Balance refresh endpoint is separate for manual refresh UX
  </action>
  <verify>
Start the server and test:
- `curl http://localhost:5002/api/admin/wallets` (should return empty array or existing Solana wallet)
- `curl -X POST http://localhost:5002/api/admin/wallets/base/create` (should create Base wallet)
- `curl http://localhost:5002/api/admin/wallets/base` (should return new wallet with balance)
  </verify>
  <done>
GET /api/admin/wallets returns all wallets with balances. POST /api/admin/wallets/:chain/create works for both chains. GET /api/admin/wallets/:chain returns specific wallet. API client has all new methods.
  </done>
</task>

</tasks>

<verification>
1. Database migration applied successfully (check server logs)
2. `curl http://localhost:5002/api/admin/wallets` returns proper JSON array
3. Can create wallets for both Solana and Base via API
4. Balance fetching works for both chains
5. TypeScript compiles without errors: `cd packages/server && pnpm build`
</verification>

<success_criteria>
- User can have wallets on both Solana and Base chains stored in database
- API returns wallet info and balances for each chain
- Wallet creation works independently per chain
- Backward compatibility maintained for existing `/wallet` endpoint
</success_criteria>

<output>
After completion, create `.planning/phases/18-multi-chain-wallet-infrastructure/18-01-SUMMARY.md`
</output>
