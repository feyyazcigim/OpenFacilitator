---
phase: 18-multi-chain-wallet-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - apps/dashboard/package.json
  - apps/dashboard/src/components/subscriptions/wallet-cards.tsx
  - apps/dashboard/src/components/subscriptions/wallet-card.tsx
  - apps/dashboard/src/app/subscriptions/page.tsx
autonomous: true

must_haves:
  truths:
    - "User sees both Base and Solana wallet cards side by side"
    - "Each wallet shows balance with chain logo and name"
    - "User can copy wallet address with toast feedback"
    - "User can click refresh to update balance"
    - "Zero balance state emphasizes funding action"
  artifacts:
    - path: "apps/dashboard/src/components/subscriptions/wallet-cards.tsx"
      provides: "Container for both wallet cards"
      min_lines: 30
    - path: "apps/dashboard/src/components/subscriptions/wallet-card.tsx"
      provides: "Individual wallet card with balance, copy, refresh"
      contains: "WalletCard"
    - path: "apps/dashboard/src/app/subscriptions/page.tsx"
      provides: "Updated subscriptions page with wallet cards"
      contains: "WalletCards"
  key_links:
    - from: "apps/dashboard/src/components/subscriptions/wallet-cards.tsx"
      to: "/api/admin/wallets"
      via: "useQuery with api.getSubscriptionWallets"
      pattern: "getSubscriptionWallets"
    - from: "apps/dashboard/src/components/subscriptions/wallet-card.tsx"
      to: "api.refreshWalletBalance"
      via: "onClick refetch"
      pattern: "refreshWalletBalance"
---

<objective>
Create wallet cards UI showing Base and Solana wallets with balances, copy, and refresh

Purpose: Users can see their subscription wallet balances and fund them via external transfers
Output: Two wallet cards displayed on Subscriptions page with full wallet management UX
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-multi-chain-wallet-infrastructure/18-CONTEXT.md
@.planning/phases/18-multi-chain-wallet-infrastructure/18-RESEARCH.md
@.planning/phases/18-multi-chain-wallet-infrastructure/18-01-SUMMARY.md
@apps/dashboard/src/app/subscriptions/page.tsx
@apps/dashboard/src/components/subscriptions/status-card.tsx
@apps/dashboard/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @solana/spl-token and create WalletCard component</name>
  <files>
    apps/dashboard/package.json
    apps/dashboard/src/components/subscriptions/wallet-card.tsx
  </files>
  <action>
1. Add @solana/spl-token to dashboard dependencies:
   ```bash
   cd apps/dashboard && pnpm add @solana/spl-token
   ```
   (Note: This is used by the server for Solana USDC balance - adding to dashboard for potential future client-side use)

2. Create `wallet-card.tsx` - individual wallet card component:

```typescript
'use client';

import { useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Copy, RefreshCw, ExternalLink } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import { cn } from '@/lib/utils';

interface WalletCardProps {
  network: 'solana' | 'base';
  address: string | null;
  balance: string;
  isLoading?: boolean;
  isRefreshing?: boolean;
  onRefresh: () => void;
  onCreate: () => void;
  isCreating?: boolean;
}

// Chain configuration
const CHAIN_CONFIG = {
  solana: {
    name: 'Solana',
    logo: '/chains/solana.svg', // We'll use text fallback if missing
    explorerUrl: 'https://solscan.io/account/',
    explorerName: 'Solscan',
    color: 'from-purple-500/10 to-purple-600/5',
  },
  base: {
    name: 'Base',
    logo: '/chains/base.svg',
    explorerUrl: 'https://basescan.org/address/',
    explorerName: 'Basescan',
    color: 'from-blue-500/10 to-blue-600/5',
  },
};

function truncateAddress(address: string): string {
  return `${address.slice(0, 6)}...${address.slice(-4)}`;
}

export function WalletCard({
  network,
  address,
  balance,
  isLoading,
  isRefreshing,
  onRefresh,
  onCreate,
  isCreating,
}: WalletCardProps) {
  const { toast } = useToast();
  const config = CHAIN_CONFIG[network];
  const [justUpdated, setJustUpdated] = useState(false);

  const handleCopy = async () => {
    if (!address) return;
    await navigator.clipboard.writeText(address);
    toast({
      title: 'Address copied!',
      description: 'Wallet address copied to clipboard.',
    });
  };

  const handleRefresh = () => {
    onRefresh();
    // Brief highlight effect when balance updates
    setTimeout(() => setJustUpdated(true), 500);
    setTimeout(() => setJustUpdated(false), 2000);
  };

  const isZeroBalance = balance === '0.00' || balance === '0';
  const hasWallet = !!address;

  return (
    <Card className={cn('relative overflow-hidden', !hasWallet && 'border-dashed')}>
      {/* Subtle gradient background */}
      <div className={cn('absolute inset-0 bg-gradient-to-br opacity-50', config.color)} />

      <CardHeader className="relative pb-2">
        <CardTitle className="text-base font-medium flex items-center gap-2">
          {/* Chain logo placeholder - using first letter as fallback */}
          <div className={cn(
            'w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold',
            network === 'solana' ? 'bg-purple-100 text-purple-600 dark:bg-purple-900/30 dark:text-purple-400' : 'bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400'
          )}>
            {config.name[0]}
          </div>
          {config.name} Wallet
        </CardTitle>
      </CardHeader>

      <CardContent className="relative space-y-4">
        {!hasWallet ? (
          /* No wallet state */
          <div className="text-center py-4">
            <p className="text-sm text-muted-foreground mb-3">
              No {config.name} wallet yet
            </p>
            <Button
              onClick={onCreate}
              disabled={isCreating}
              size="sm"
            >
              {isCreating ? 'Creating...' : `Create ${config.name} Wallet`}
            </Button>
          </div>
        ) : (
          <>
            {/* Balance display */}
            <div className="space-y-1">
              <p className="text-sm text-muted-foreground">Balance</p>
              <div className="flex items-center gap-2">
                {isLoading || isRefreshing ? (
                  <div className="h-8 w-24 bg-muted animate-pulse rounded" />
                ) : (
                  <p className={cn(
                    'text-2xl font-bold transition-colors duration-500',
                    justUpdated && 'text-green-500',
                    isZeroBalance && 'text-muted-foreground'
                  )}>
                    {balance} <span className="text-base font-normal text-muted-foreground">USDC</span>
                  </p>
                )}
                <Button
                  variant="ghost"
                  size="icon"
                  className="h-8 w-8"
                  onClick={handleRefresh}
                  disabled={isRefreshing}
                >
                  <RefreshCw className={cn('h-4 w-4', isRefreshing && 'animate-spin')} />
                </Button>
              </div>
            </div>

            {/* Zero balance funding prompt */}
            {isZeroBalance && !isLoading && (
              <div className="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-3">
                <p className="text-sm text-amber-800 dark:text-amber-200">
                  Fund this wallet with USDC to enable subscription payments.
                </p>
              </div>
            )}

            {/* Address with copy and explorer link */}
            <div className="space-y-1">
              <p className="text-sm text-muted-foreground">Address</p>
              <div className="flex items-center gap-2">
                <code className="text-sm font-mono bg-muted px-2 py-1 rounded">
                  {truncateAddress(address)}
                </code>
                <Button
                  variant="ghost"
                  size="icon"
                  className="h-8 w-8"
                  onClick={handleCopy}
                  title="Copy address"
                >
                  <Copy className="h-4 w-4" />
                </Button>
                <a
                  href={`${config.explorerUrl}${address}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="inline-flex items-center justify-center h-8 w-8 rounded-md hover:bg-muted transition-colors"
                  title={`View on ${config.explorerName}`}
                >
                  <ExternalLink className="h-4 w-4 text-muted-foreground" />
                </a>
              </div>
            </div>
          </>
        )}
      </CardContent>
    </Card>
  );
}
```

Key features:
- Truncated address display (0x1234...abcd)
- Copy button with toast notification
- Explorer link (Solscan/Basescan)
- Refresh button with spinner and brief highlight on change
- Zero balance state with funding prompt
- No wallet state with create button
- Loading shimmer during refresh
  </action>
  <verify>
TypeScript compiles: `cd apps/dashboard && pnpm build`
  </verify>
  <done>
WalletCard component created with all UX features: balance display, copy, refresh, explorer link, zero balance prompt.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create WalletCards container component</name>
  <files>
    apps/dashboard/src/components/subscriptions/wallet-cards.tsx
  </files>
  <action>
Create `wallet-cards.tsx` - container that fetches and displays both wallets:

```typescript
'use client';

import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { api, type SubscriptionWallet } from '@/lib/api';
import { WalletCard } from './wallet-card';
import { useToast } from '@/hooks/use-toast';
import { useState } from 'react';

export function WalletCards() {
  const queryClient = useQueryClient();
  const { toast } = useToast();
  const [refreshingChain, setRefreshingChain] = useState<'solana' | 'base' | null>(null);

  // Fetch all wallets
  const { data: wallets, isLoading } = useQuery({
    queryKey: ['subscriptionWallets'],
    queryFn: () => api.getSubscriptionWallets(),
  });

  // Create wallet mutation
  const createMutation = useMutation({
    mutationFn: (chain: 'solana' | 'base') => api.createSubscriptionWallet(chain),
    onSuccess: (result, chain) => {
      toast({
        title: 'Wallet created!',
        description: `Your ${chain === 'solana' ? 'Solana' : 'Base'} wallet is ready.`,
      });
      queryClient.invalidateQueries({ queryKey: ['subscriptionWallets'] });
    },
    onError: (error) => {
      toast({
        title: 'Failed to create wallet',
        description: error instanceof Error ? error.message : 'Please try again.',
        variant: 'destructive',
      });
    },
  });

  // Refresh balance for specific chain
  const handleRefresh = async (chain: 'solana' | 'base') => {
    setRefreshingChain(chain);
    try {
      await api.refreshWalletBalance(chain);
      await queryClient.invalidateQueries({ queryKey: ['subscriptionWallets'] });
    } catch (error) {
      toast({
        title: 'Failed to refresh balance',
        description: 'Please try again.',
        variant: 'destructive',
      });
    } finally {
      setRefreshingChain(null);
    }
  };

  // Find wallets by network
  const solanaWallet = wallets?.find((w: SubscriptionWallet) => w.network === 'solana');
  const baseWallet = wallets?.find((w: SubscriptionWallet) => w.network === 'base');

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
      <WalletCard
        network="base"
        address={baseWallet?.address || null}
        balance={baseWallet?.balance || '0.00'}
        isLoading={isLoading}
        isRefreshing={refreshingChain === 'base'}
        onRefresh={() => handleRefresh('base')}
        onCreate={() => createMutation.mutate('base')}
        isCreating={createMutation.isPending && createMutation.variables === 'base'}
      />
      <WalletCard
        network="solana"
        address={solanaWallet?.address || null}
        balance={solanaWallet?.balance || '0.00'}
        isLoading={isLoading}
        isRefreshing={refreshingChain === 'solana'}
        onRefresh={() => handleRefresh('solana')}
        onCreate={() => createMutation.mutate('solana')}
        isCreating={createMutation.isPending && createMutation.variables === 'solana'}
      />
    </div>
  );
}
```

Key features:
- Fetches all wallets via single query
- Creates wallets per chain via mutation
- Handles refresh per card independently
- Shows Base first (per CONTEXT.md - new feature emphasis)
- Loading states passed to cards
  </action>
  <verify>
TypeScript compiles: `cd apps/dashboard && pnpm build`
  </verify>
  <done>
WalletCards container fetches wallets, handles create/refresh mutations, renders both cards side by side.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate wallet cards into Subscriptions page</name>
  <files>
    apps/dashboard/src/app/subscriptions/page.tsx
  </files>
  <action>
Update the Subscriptions page to include the wallet cards section:

1. Import WalletCards component
2. Add wallet cards section between status/billing cards and payment history
3. Update BillingCard note to mention both chains

Changes to `page.tsx`:

```typescript
// Add import
import { WalletCards } from '@/components/subscriptions/wallet-cards';

// In the JSX, after the status/billing cards grid and before PaymentHistory:
{/* Wallet Cards Section */}
<div className="mb-8">
  <h2 className="text-lg font-semibold mb-4">Subscription Wallets</h2>
  <p className="text-sm text-muted-foreground mb-4">
    Fund these wallets with USDC to pay for your subscription. You can use either chain.
  </p>
  <WalletCards />
</div>
```

The page layout will be:
1. Header (Subscriptions title)
2. Status Card + Billing Card (side by side)
3. **Subscription Wallets section (NEW)** - Base + Solana wallet cards
4. Payment History

Also update BillingCard component to reflect multi-chain support:
- Change the note from "Payments are processed from your subscription wallet in USDC on Solana."
- To: "Payments are processed from your subscription wallets in USDC."
  </action>
  <verify>
Start dev server (`pnpm dev`) and navigate to /subscriptions. Verify:
- Wallet cards section appears below status/billing cards
- Both Base and Solana wallet cards are visible
- Create wallet buttons work
- Copy address works with toast
- Refresh balance works with spinner
  </verify>
  <done>
Subscriptions page displays wallet cards section with both Base and Solana wallets. Full UX working: create, copy, refresh, explorer links.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /subscriptions page
2. Verify two wallet cards displayed (Base and Solana)
3. Click "Create Base Wallet" - wallet should be created with address shown
4. Click copy icon - toast should appear "Address copied!"
5. Click external link - should open Basescan/Solscan in new tab
6. Click refresh - spinner should appear, balance should update
7. If zero balance, funding prompt should be visible
8. TypeScript compiles: `cd apps/dashboard && pnpm build`
</verification>

<success_criteria>
- User sees both Base and Solana wallet cards on Subscriptions page
- Each wallet shows balance with chain identifier
- User can copy wallet addresses with toast feedback
- User can refresh balances manually
- Zero balance state emphasizes funding action
- Explorer links work for both chains
</success_criteria>

<output>
After completion, create `.planning/phases/18-multi-chain-wallet-infrastructure/18-02-SUMMARY.md`
</output>
